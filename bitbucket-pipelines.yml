image: node:16.11.1-buster

definitions:
  services:
    docker:
      memory: 3072
  steps:
    - step: &test
        name: Test
        script:
          - npm ci
          - npm run lint
          - npm run test

    - step: &publish
        name: Publish 
        script:
          - VERSION=$(echo $BITBUCKET_TAG | sed 's/^.*[A-Za-z]-//g')
          - npm version $VERSION --allow-same-version
          - npm ci
          - git config --global user.name "Automated NPM Release"
          - git config --global user.email "sysadmin+npm-deploy@aligent.com.au"
          - git push
          - npm run build
          - pipe: atlassian/npm-publish:0.3.3
            variables:
              NPM_TOKEN: $NPM_TOKEN

pipelines:
  pull-requests:
    "**":
      - step: *test
  tags:
    release-*:
      - step: *publish
